<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spirro - Estoque PA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #485434 0%, #6b7545 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #485434;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .last-update {
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            background: #D25E13;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #b84f0f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(210, 94, 19, 0.4);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #485434;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }

        .recent-activity {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .recent-activity h2 {
            color: #485434;
            margin-bottom: 20px;
        }

        .activity-item {
            padding: 15px;
            border-left: 4px solid #D25E13;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .categories {
            display: grid;
            gap: 30px;
        }

        .category {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .category h2 {
            color: #485434;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #D25E13;
        }

        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: linear-gradient(135deg, #485434 0%, #5d6641 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .product-name {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .product-quantity {
            font-size: 2.5em;
            font-weight: bold;
            margin: 15px 0;
        }

        .product-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .low-stock {
            background: linear-gradient(135deg, #D25E13 0%, #b84f0f 100%);
        }

        .search-filter {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .search-filter input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì¶ Controle Produto Acabado - PULM√ÉO</h1>
            <p class="last-update" id="lastUpdate">Carregando...</p>
        </header>

        <div id="mainContent">
            <div class="stats" id="stats"></div>

            <div class="recent-activity">
                <h2>üì• √öltimas 10 Entradas</h2>
                <div id="recentEntradas">Carregando...</div>
            </div>

            <div class="recent-activity">
                <h2>üì§ √öltimas 10 Sa√≠das</h2>
                <div id="recentSaidas">Carregando...</div>
            </div>

            <div class="search-filter">
                <input type="text" id="searchInput" placeholder="üîç Buscar produto..." onkeyup="filterProducts()">
            </div>

            <div class="categories" id="categories"></div>
        </div>

        <button class="btn" onclick="loadData()" style="position: fixed; bottom: 20px; right: 20px;">üîÑ Atualizar Dados</button>
    </div>

    <script>
        // ========================================
        // ‚öôÔ∏è CONFIGURA√á√ïES EDIT√ÅVEIS
        // ========================================
        
        const config = {
            sheetId: '1rPtN3xvAWr2jz8LT-aT9Y_hs3QJxlbjXn6GLP0GNUvA',
            gidGeral: '1953407461',
            sheetIdEntrada: '1yzB4R87MKdXqJbUJQiYsvJ9uQxlkcJuDi-Ppq2Da-Ac',
            gidEntrada: '151124392',
            sheetIdSaida: '1_8LmoLSTqfphpajyFuFqkBzR4HNj7XXVpHKF2Wj8Z6g',
            gidSaida: '1276243802',
            
            // ‚úèÔ∏è VOC√ä PODE EDITAR AQUI:
            quantidadeEntradas: 10,  // ‚Üê ALTERE AQUI: N√∫mero de entradas para mostrar
            quantidadeSaidas: 10,    // ‚Üê ALTERE AQUI: N√∫mero de sa√≠das para mostrar
            mostrarProdutosZerados: false  // ‚Üê ALTERE AQUI: true = mostra zerados, false = esconde
        };

        let allProducts = [];

        async function loadData() {
            try {
                const urlGeral = `https://docs.google.com/spreadsheets/d/${config.sheetId}/export?format=csv&gid=${config.gidGeral}`;
                
                console.log('Carregando dados gerais...');
                
                const response = await fetch(urlGeral, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-store',
                    redirect: 'follow'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                processData(rows);
                
                // Carrega e exibe ENTRADAS separadamente
                try {
                    if (config.sheetIdEntrada && config.gidEntrada) {
                        console.log('Carregando entradas...');
                        const urlEntrada = `https://docs.google.com/spreadsheets/d/${config.sheetIdEntrada}/export?format=csv&gid=${config.gidEntrada}`;
                        const respEntrada = await fetch(urlEntrada, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-store'
                        });
                        
                        if (respEntrada.ok) {
                            const csvEntrada = await respEntrada.text();
                            const rowsEntrada = parseCSV(csvEntrada);
                            console.log('Entradas:', rowsEntrada.length, 'linhas');
                            displayEntradas(rowsEntrada);
                        }
                    }
                } catch (err) {
                    console.log('Erro entradas:', err);
                    document.getElementById('recentEntradas').innerHTML = 
                        '<div style="color: #999;">Entradas indispon√≠veis (verifique se a planilha est√° publicada e compartilhada)</div>';
                }
                
                // Carrega e exibe SA√çDAS separadamente
                try {
                    if (config.sheetIdSaida && config.gidSaida) {
                        console.log('Carregando sa√≠das...');
                        const urlSaida = `https://docs.google.com/spreadsheets/d/${config.sheetIdSaida}/export?format=csv&gid=${config.gidSaida}`;
                        const respSaida = await fetch(urlSaida, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-store'
                        });
                        
                        if (respSaida.ok) {
                            const csvSaida = await respSaida.text();
                            const rowsSaida = parseCSV(csvSaida);
                            console.log('Sa√≠das:', rowsSaida.length, 'linhas');
                            displaySaidas(rowsSaida);
                        }
                    }
                } catch (err) {
                    console.log('Erro sa√≠das:', err);
                    document.getElementById('recentSaidas').innerHTML = 
                        '<div style="color: #999;">Sa√≠das indispon√≠veis (verifique se a planilha est√° publicada e compartilhada)</div>';
                }
                
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('categories').innerHTML = 
                    `<div class="error">
                        <strong>Erro: ${error.message}</strong><br><br>
                        <button class="btn" onclick="loadData()">üîÑ Tentar Novamente</button>
                    </div>`;
            }
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const result = [];
            
            for (let line of lines) {
                if (!line.trim()) continue;
                
                const row = [];
                let currentField = '';
                let insideQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"' && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        row.push(currentField);
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                
                row.push(currentField);
                result.push(row);
            }
            
            return result;
        }

        function processData(rows) {
            if (!rows || rows.length < 2) {
                console.error('Dados insuficientes');
                return;
            }
            
            const allProducts = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                
                if (!row || row.length < 5) continue;
                
                const produto = row[0] ? row[0].trim() : '';
                if (!produto) continue;
                
                const entrada = parseInt(row[1]) || 0;
                const saida = parseInt(row[2]) || 0;
                const saldo = parseInt(row[3]) || 0;
                const familia = row[4] ? row[4].trim() : 'Sem Categoria';
                
                allProducts.push({
                    produto: produto,
                    entrada: entrada,
                    saida: saida,
                    saldo: saldo,
                    familia: familia
                });
            }
            
            if (allProducts.length === 0) {
                document.getElementById('categories').innerHTML = 
                    '<div class="error">Nenhum produto encontrado.</div>';
                return;
            }
            
            // Calcula estat√≠sticas com TODOS os produtos
            displayStats(allProducts);
            
            // Filtra produtos para exibi√ß√£o (remove zerados se configurado)
            const productsToDisplay = config.mostrarProdutosZerados 
                ? allProducts 
                : allProducts.filter(p => p.saldo > 0);
            
            if (productsToDisplay.length === 0) {
                document.getElementById('categories').innerHTML = 
                    '<div class="error">Nenhum produto com saldo maior que zero para exibir.</div>';
            } else {
                displayProducts(productsToDisplay);
            }
            
            document.getElementById('lastUpdate').textContent = 
                `√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}`;
        }

        function displayStats(products) {
            const produtosEmEstoque = products.filter(p => p.saldo > 0).length;
            const totalEstoque = products.reduce((sum, p) => sum + p.saldo, 0);
            const totalEntradas = products.reduce((sum, p) => sum + p.entrada, 0);
            const totalSaidas = products.reduce((sum, p) => sum + p.saida, 0);
            const categorias = [...new Set(products.map(p => p.familia))].length;
            const produtosZerados = products.filter(p => p.saldo === 0).length;
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <h3>${produtosEmEstoque}</h3>
                    <p>Produtos em Estoque</p>
                </div>
                <div class="stat-card">
                    <h3>${totalEstoque}</h3>
                    <p>Saldo Total</p>
                </div>
                <div class="stat-card">
                    <h3>${totalEntradas}</h3>
                    <p>Total de Entradas</p>
                </div>
                <div class="stat-card">
                    <h3>${totalSaidas}</h3>
                    <p>Total de Sa√≠das</p>
                </div>
                <div class="stat-card">
                    <h3>${categorias}</h3>
                    <p>Categorias/Fam√≠lias</p>
                </div>
                <div class="stat-card">
                    <h3 style="color: #D25E13;">${produtosZerados}</h3>
                    <p>Produtos Zerados</p>
                </div>
            `;
        }

        function displayProducts(products) {
            const byCategory = {};
            
            products.forEach(product => {
                if (!byCategory[product.familia]) {
                    byCategory[product.familia] = [];
                }
                byCategory[product.familia].push(product);
            });
            
            let html = '';
            
            Object.keys(byCategory).sort().forEach(categoria => {
                html += `
                    <div class="category">
                        <h2>${categoria}</h2>
                        <div class="products">
                `;
                
                byCategory[categoria].forEach(product => {
                    const lowStock = product.saldo > 0 && product.saldo < 10 ? 'low-stock' : '';
                    html += `
                        <div class="product-card ${lowStock}" data-product="${product.produto.toLowerCase()}">
                            <div class="product-name">${product.produto}</div>
                            <div class="product-label">Saldo em Estoque:</div>
                            <div class="product-quantity">${product.saldo}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 0.9em;">
                                <div>
                                    <div style="opacity: 0.8;">Entradas:</div>
                                    <div style="font-weight: bold; font-size: 1.2em;">${product.entrada}</div>
                                </div>
                                <div>
                                    <div style="opacity: 0.8;">Sa√≠das:</div>
                                    <div style="font-weight: bold; font-size: 1.2em;">${product.saida}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('categories').innerHTML = html;
        }

        function extrairData(row) {
            try {
                for (let i = row.length - 1; i >= 0; i--) {
                    const campo = row[i];
                    if (campo && (campo.includes('/') || campo.includes('-')) && campo.length >= 8) {
                        const partes = campo.split('/');
                        if (partes.length === 3) {
                            return new Date(partes[2], partes[1] - 1, partes[0]);
                        }
                        return new Date(campo);
                    }
                }
            } catch (e) {
                console.log('Erro data:', e);
            }
            return new Date();
        }

        function displayEntradas(rows) {
            if (!rows || rows.length < 2) {
                document.getElementById('recentEntradas').innerHTML = 
                    '<div style="color: #999;">Nenhuma entrada dispon√≠vel</div>';
                return;
            }

            // Pega as primeiras X entradas (j√° deve estar ordenada de forma decrescente na planilha)
            const quantidade = Math.min(config.quantidadeEntradas + 1, rows.length);
            const entradasRecentes = rows.slice(1, quantidade);

            let html = '';

            entradasRecentes.forEach((row, index) => {
                if (row.length > 0 && row[0]) {
                    const dados = row.filter(cell => cell && cell.trim()).join(' ‚Ä¢ ');
                    
                    html += `
                        <div class="activity-item" style="border-left-color: #485434;">
                            <strong>üì• Entrada ${index + 1}</strong>
                            <div>${dados}</div>
                        </div>
                    `;
                }
            });

            document.getElementById('recentEntradas').innerHTML = html || 
                '<div style="color: #999;">Nenhuma entrada dispon√≠vel</div>';
        }

        function displaySaidas(rows) {
            if (!rows || rows.length < 2) {
                document.getElementById('recentSaidas').innerHTML = 
                    '<div style="color: #999;">Nenhuma sa√≠da dispon√≠vel</div>';
                return;
            }

            // Pega as primeiras X sa√≠das (j√° deve estar ordenada de forma decrescente na planilha)
            const quantidade = Math.min(config.quantidadeSaidas + 1, rows.length);
            const saidasRecentes = rows.slice(1, quantidade);

            let html = '';

            saidasRecentes.forEach((row, index) => {
                if (row.length > 0 && row[0]) {
                    const dados = row.filter(cell => cell && cell.trim()).join(' ‚Ä¢ ');
                    
                    html += `
                        <div class="activity-item" style="border-left-color: #D25E13;">
                            <strong>üì§ Sa√≠da ${index + 1}</strong>
                            <div>${dados}</div>
                        </div>
                    `;
                }
            });

            document.getElementById('recentSaidas').innerHTML = html || 
                '<div style="color: #999;">Nenhuma sa√≠da dispon√≠vel</div>';
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const productCards = document.querySelectorAll('.product-card');
            
            productCards.forEach(card => {
                const productName = card.getAttribute('data-product');
                if (productName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        setInterval(loadData, 300000);
        loadData();
    </script>
</body>
</html>